<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solutions Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .video-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: #f0f0f0;
            margin-bottom: 15px;
        }
        .solution-card {
            border-left: 4px solid #6A4C9D;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Solutions Management</h1>
        
        <div class="form-container mb-4">
            <h2 id="form-title">Add New Solution</h2>
            <form id="solution-form">
                <input type="hidden" id="solution-id">
                
                <div class="mb-3">
                    <label for="title" class="form-label">Title*</label>
                    <input type="text" class="form-control" id="title" required>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">Card 1</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="description1" class="form-label">Description</label>
                            <textarea class="form-control" id="description1" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="youtube_url1" class="form-label">YouTube URL</label>
                            <input type="url" class="form-control" id="youtube_url1">
                            <div class="video-preview mt-2" id="preview1"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header">Card 2 (Optional)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="description2" class="form-label">Description</label>
                            <textarea class="form-control" id="description2" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="youtube_url2" class="form-label">YouTube URL</label>
                            <input type="url" class="form-control" id="youtube_url2">
                            <div class="video-preview mt-2" id="preview2"></div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="cancel-btn" style="display: none;">Cancel</button>
                    <button type="submit" class="btn btn-primary ms-auto">Save Solution</button>
                </div>
            </form>
        </div>
        
        <h2 class="mb-3">Existing Solutions</h2>
        <div id="solutions-list" class="row">
            <!-- Solutions will be loaded here -->
            <div class="col-12">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase initialization
        const supabaseUrl = 'https://yccunwxamevfxiwmrpiu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InljY3Vud3hhbWV2Znhpd21ycGl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc1OTE0NjMsImV4cCI6MjA2MzE2NzQ2M30.NGoQBYT6nvxTdz1g5JJ4ZNgvo8zwjgEuyvMfvQmPSNw';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM elements
        const form = document.getElementById('solution-form');
        const solutionsList = document.getElementById('solutions-list');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancel-btn');
        let isEditing = false;
        let currentEditId = null;

        // Initialize the admin panel
        document.addEventListener('DOMContentLoaded', () => {
            loadSolutions();
            setupEventListeners();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Form submission
            form.addEventListener('submit', handleFormSubmit);
            
            // Cancel edit
            cancelBtn.addEventListener('click', resetForm);
            
            // YouTube URL previews
            document.getElementById('youtube_url1').addEventListener('input', (e) => {
                updateVideoPreview('preview1', e.target.value);
            });
            
            document.getElementById('youtube_url2').addEventListener('input', (e) => {
                updateVideoPreview('preview2', e.target.value);
            });
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                description1: document.getElementById('description1').value,
                youtube_url1: document.getElementById('youtube_url1').value,
                description2: document.getElementById('description2').value,
                youtube_url2: document.getElementById('youtube_url2').value
            };
            
            if (!formData.title) {
                alert('Title is required');
                return;
            }
            
            try {
                if (isEditing) {
                    // Update existing solution
                    const { error } = await supabase
                        .from('solutions')
                        .update(formData)
                        .eq('id', currentEditId);
                    
                    if (error) throw error;
                    alert('Solution updated successfully!');
                } else {
                    // Create new solution
                    const { error } = await supabase
                        .from('solutions')
                        .insert([formData]);
                    
                    if (error) throw error;
                    alert('Solution created successfully!');
                }
                
                resetForm();
                loadSolutions();
            } catch (error) {
                console.error('Error saving solution:', error);
                alert('Error saving solution: ' + error.message);
            }
        }

        // Load all solutions
        async function loadSolutions() {
            solutionsList.innerHTML = `
                <div class="col-12">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                const { data, error } = await supabase
                    .from('solutions')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (data.length === 0) {
                    solutionsList.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">No solutions found. Add one to get started.</div>
                        </div>
                    `;
                    return;
                }
                
                renderSolutionsList(data);
            } catch (error) {
                console.error('Error loading solutions:', error);
                solutionsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">Failed to load solutions: ${error.message}</div>
                    </div>
                `;
            }
        }

        // Render solutions list
        function renderSolutionsList(solutions) {
            solutionsList.innerHTML = '';
            
            solutions.forEach(solution => {
                const solutionElement = document.createElement('div');
                solutionElement.className = 'col-md-6 mb-3';
                solutionElement.innerHTML = `
                    <div class="card solution-card">
                        <div class="card-body">
                            <h5 class="card-title">${solution.title}</h5>
                            
                            <div class="mb-2">
                                <strong>Card 1:</strong>
                                <p>${solution.description1 || 'No description'}</p>
                                ${solution.youtube_url1 ? 
                                    `<div class="ratio ratio-16x9">
                                        <iframe src="${getEmbedUrl(solution.youtube_url1)}" allowfullscreen></iframe>
                                    </div>` : 
                                    '<p>No video</p>'}
                            </div>
                            
                            ${solution.description2 || solution.youtube_url2 ? `
                            <div class="mb-2">
                                <strong>Card 2:</strong>
                                <p>${solution.description2 || 'No description'}</p>
                                ${solution.youtube_url2 ? 
                                    `<div class="ratio ratio-16x9">
                                        <iframe src="${getEmbedUrl(solution.youtube_url2)}" allowfullscreen></iframe>
                                    </div>` : 
                                    solution.description2 ? '<p>No video</p>' : ''}
                            </div>
                            ` : ''}
                            
                            <div class="action-buttons mt-3">
                                <button class="btn btn-sm btn-warning edit-btn" data-id="${solution.id}">Edit</button>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${solution.id}">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                
                solutionsList.appendChild(solutionElement);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editSolution(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteSolution(btn.dataset.id));
            });
        }

        // Edit a solution
        async function editSolution(id) {
            try {
                const { data, error } = await supabase
                    .from('solutions')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Fill the form with the solution data
                document.getElementById('solution-id').value = data.id;
                document.getElementById('title').value = data.title;
                document.getElementById('description1').value = data.description1 || '';
                document.getElementById('youtube_url1').value = data.youtube_url1 || '';
                document.getElementById('description2').value = data.description2 || '';
                document.getElementById('youtube_url2').value = data.youtube_url2 || '';
                
                // Update previews
                updateVideoPreview('preview1', data.youtube_url1);
                updateVideoPreview('preview2', data.youtube_url2);
                
                // Change form to edit mode
                formTitle.textContent = 'Edit Solution';
                cancelBtn.style.display = 'block';
                isEditing = true;
                currentEditId = id;
                
                // Scroll to form
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error editing solution:', error);
                alert('Error editing solution: ' + error.message);
            }
        }

        // Delete a solution
        async function deleteSolution(id) {
            if (!confirm('Are you sure you want to delete this solution?')) return;
            
            try {
                const { error } = await supabase
                    .from('solutions')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('Solution deleted successfully!');
                loadSolutions();
            } catch (error) {
                console.error('Error deleting solution:', error);
                alert('Error deleting solution: ' + error.message);
            }
        }

        // Reset the form
        function resetForm() {
            form.reset();
            document.getElementById('solution-id').value = '';
            document.getElementById('preview1').innerHTML = '';
            document.getElementById('preview2').innerHTML = '';
            formTitle.textContent = 'Add New Solution';
            cancelBtn.style.display = 'none';
            isEditing = false;
            currentEditId = null;
        }

        // Update video preview
        function updateVideoPreview(previewId, url) {
            const preview = document.getElementById(previewId);
            
            if (!url) {
                preview.innerHTML = '';
                return;
            }
            
            const embedUrl = getEmbedUrl(url);
            if (embedUrl) {
                preview.innerHTML = `
                    <iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>
                `;
            } else {
                preview.innerHTML = '<p>Invalid or unsupported video URL</p>';
            }
        }

        // Helper function to convert YouTube URLs to embed URLs
        function getEmbedUrl(url) {
            if (!url) return '';
            
            // Handle YouTube URLs
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                const videoId = (match && match[2].length === 11) ? match[2] : null;
                
                if (videoId) {
                    return `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`;
                }
            }
            
            // Handle Vimeo URLs
            if (url.includes('vimeo.com')) {
                const regExp = /^.*(vimeo\.com\/)((channels\/[A-z]+\/)|(groups\/[A-z]+\/videos\/))?([0-9]+)/;
                const match = url.match(regExp);
                const videoId = match ? match[5] : null;
                
                if (videoId) {
                    return `https://player.vimeo.com/video/${videoId}?title=0&byline=0&portrait=0`;
                }
            }
            
            // Return original URL if not recognized
            return url;
        }
    </script>
</body>
</html>